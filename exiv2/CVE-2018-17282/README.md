# CVE-2018-17282
## Test Environment
Ubuntu 16.04, 64bit  
Exiv2 (master 37b8725)

## How to trigger
`$ exiv2 $POC`

## Reference
https://github.com/Exiv2/exiv2/issues/457  
http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-17282

## Credits
Yanhao(unfuzzable123@gmail.com)  
Marsman1996(lqliuyuwei@outlook.com)

## Details
### GDB report
```
Program received signal SIGSEGV, Segmentation fault.
__memmove_avx_unaligned ()
    at ../sysdeps/x86_64/multiarch/memcpy-avx-unaligned.S:164
164	../sysdeps/x86_64/multiarch/memcpy-avx-unaligned.S: No such file or directory.
(gdb) bt
#0  __memmove_avx_unaligned ()
    at ../sysdeps/x86_64/multiarch/memcpy-avx-unaligned.S:164
#1  0x00007ffff797d3e0 in std::__copy_move<false, true, std::random_access_iterator_tag>::__copy_m<unsigned char> (
    __first=0x65c0c0 <incomplete sequence \350>, __last=0x65c0c1 "", 
    __result=0x0) at /usr/include/c++/5/bits/stl_algobase.h:384
#2  0x00007ffff799f6a7 in std::__copy_move_a<false, unsigned char const*, unsigned char*> (__first=0x65c0c0 <incomplete sequence \350>, __last=0x65c0c1 "", 
    __result=0x0) at /usr/include/c++/5/bits/stl_algobase.h:402
#3  0x00007ffff79bef6c in std::__copy_move_a2<false, __gnu_cxx::__normal_iterator<unsigned char const*, std::vector<unsigned char, std::allocator<unsigned char> > >, unsigned char*> (__first=232 '\350', __last=0 '\000', __result=0x0)
    at /usr/include/c++/5/bits/stl_algobase.h:440
#4  0x00007ffff79be1b1 in std::copy<__gnu_cxx::__normal_iterator<unsigned char const*, std::vector<unsigned char, std::allocator<unsigned char> > >, unsigned char*> (__first=232 '\350', __last=0 '\000', __result=0x0)
    at /usr/include/c++/5/bits/stl_algobase.h:472
#5  0x00007ffff79b867e in Exiv2::DataValue::copy (this=0x65c090, buf=0x0)
    at /home/marsman/Desktop/crashana/exiv2/exiv2/src/value.cpp:242
#6  0x00007ffff795c798 in Exiv2::Exifdatum::copy (this=0x65bfc0, buf=0x0, 
    byteOrder=Exiv2::littleEndian)
    at /home/marsman/Desktop/crashana/exiv2/exiv2/src/exif.cpp:357
#7  0x00007ffff79b3824 in Exiv2::TiffImage::readMetadata (this=0x659a50)
   e/marsman/Desktop/crashana/exiv2/exiv2/src/tiffimage.cpp:195
#8  0x0000000000422097 in Action::Print::printSummary (this=0x65acb0)
    at /home/marsman/Desktop/crashana/exiv2/exiv2/src/actions.cpp:286
#9  0x0000000000421d7d in Action::Print::run (this=0x65acb0, 
    path="../../poc8-DataValue::copy")
    at /home/marsman/Desktop/crashana/exiv2/exiv2/src/actions.cpp:246
#10 0x0000000000412bc3 in main (argc=2, argv=0x7fffffffddc8)
    at /home/marsman/Desktop/crashana/exiv2/exiv2/src/exiv2.cpp:167
```

### Asan report
```
./bin/exiv2 ../../poc8-DataValue\ copy 
Error: Directory Image: IFD entry 9 lies outside of the data buffer.
Warning: Directory Image, entry 0x0002 has unknown Exif (TIFF) type 0; setting type size 1.
Error: Directory Image, entry 0x0002 has invalid size 372984319*1; skipping entry.
Warning: Directory Image, entry 0x0000 has unknown Exif (TIFF) type 18735; setting type size 1.
Error: Offset of directory Image, entry 0x0000 is out of bounds: Offset = 0x49000000; truncating the entry
Warning: Directory Image, entry 0x0049 has unknown Exif (TIFF) type 16511; setting type size 1.
Error: Offset of directory Image, entry 0x0049 is out of bounds: Offset = 0x45740000; truncating the entry
Warning: Directory Image, entry 0x7458 has unknown Exif (TIFF) type 9216; setting type size 1.
Error: Offset of directory Image, entry 0x7458 is out of bounds: Offset = 0x40004000; truncating the entry
Warning: Directory Image, entry 0x00fa has unknown Exif (TIFF) type 64000; setting type size 1.
Error: Offset of directory Image, entry 0x00fa is out of bounds: Offset = 0xf5ffffff; truncating the entry
Warning: Directory Image, entry 0xf5f5 has unknown Exif (TIFF) type 0; setting type size 1.
Error: Offset of directory Image, entry 0xf5f5 is out of bounds: Offset = 0x0000f601; truncating the entry
Warning: Directory Image, entry 0x6564 has unknown Exif (TIFF) type 25459; setting type size 1.
Error: Directory Image, entry 0x6564 has invalid size 1313163634*1; skipping entry.
Warning: Directory Image, entry 0x8773 has unknown Exif (TIFF) type 64; setting type size 1.
Warning: Directory Image, entry 0x02e4 has unknown Exif (TIFF) type 0; setting type size 1.
Error: Offset of directory Image, entry 0x02e4 is out of bounds: Offset = 0x24590080; truncating the entry
ASAN:SIGSEGV
=================================================================
==31767==ERROR: AddressSanitizer: SEGV on unknown address 0x000000000000 (pc 0x7fd1a4d15934 bp 0x7fffc8f86170 sp 0x7fffc8f858f8 T0)
    #0 0x7fd1a4d15933  (/usr/lib/x86_64-linux-gnu/libasan.so.2+0xaa933)
    #1 0x7fd1a4cf7e8d in __asan_memmove (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x8ce8d)
    #2 0x7fd1a45609b5 in unsigned char* std::__copy_move<false, true, std::random_access_iterator_tag>::__copy_m<unsigned char>(unsigned char const*, unsigned char const*, unsigned char*) /usr/include/c++/5/bits/stl_algobase.h:384
    #3 0x7fd1a459a4d6 in unsigned char* std::__copy_move_a<false, unsigned char const*, unsigned char*>(unsigned char const*, unsigned char const*, unsigned char*) /usr/include/c++/5/bits/stl_algobase.h:402
    #4 0x7fd1a45d103f in unsigned char* std::__copy_move_a2<false, __gnu_cxx::__normal_iterator<unsigned char const*, std::vector<unsigned char, std::allocator<unsigned char> > >, unsigned char*>(__gnu_cxx::__normal_iterator<unsigned char const*, std::vector<unsigned char, std::allocator<unsigned char> > >, __gnu_cxx::__normal_iterator<unsigned char const*, std::vector<unsigned char, std::allocator<unsigned char> > >, unsigned char*) (/home/marsman/Desktop/crashana/exiv2/exiv2-37b8725/build_asan/lib/libexiv2.so.0+0x31503f)
    #5 0x7fd1a45cfa6d in unsigned char* std::copy<__gnu_cxx::__normal_iterator<unsigned char const*, std::vector<unsigned char, std::allocator<unsigned char> > >, unsigned char*>(__gnu_cxx::__normal_iterator<unsigned char const*, std::vector<unsigned char, std::allocator<unsigned char> > >, __gnu_cxx::__normal_iterator<unsigned char const*, std::vector<unsigned char, std::allocator<unsigned char> > >, unsigned char*) (/home/marsman/Desktop/crashana/exiv2/exiv2-37b8725/build_asan/lib/libexiv2.so.0+0x313a6d)
    #6 0x7fd1a45c52f7 in Exiv2::DataValue::copy(unsigned char*, Exiv2::ByteOrder) const /home/marsman/Desktop/crashana/exiv2/exiv2-37b8725/src/value.cpp:242
    #7 0x7fd1a452ac0a in Exiv2::Exifdatum::copy(unsigned char*, Exiv2::ByteOrder) const /home/marsman/Desktop/crashana/exiv2/exiv2-37b8725/src/exif.cpp:357
    #8 0x7fd1a45bb62a in Exiv2::TiffImage::readMetadata() /home/marsman/Desktop/crashana/exiv2/exiv2-37b8725/src/tiffimage.cpp:195
    #9 0x42b5bd in Action::Print::printSummary() /home/marsman/Desktop/crashana/exiv2/exiv2-37b8725/src/actions.cpp:286
    #10 0x42ae35 in Action::Print::run(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&) /home/marsman/Desktop/crashana/exiv2/exiv2-37b8725/src/actions.cpp:246
    #11 0x413757 in main /home/marsman/Desktop/crashana/exiv2/exiv2-37b8725/src/exiv2.cpp:167
    #12 0x7fd1a397a82f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)
    #13 0x413168 in _start (/home/marsman/Desktop/crashana/exiv2/exiv2-37b8725/build_asan/bin/exiv2+0x413168)

AddressSanitizer can not provide additional info.
SUMMARY: AddressSanitizer: SEGV ??:0 ??
==31767==ABORTING
```